<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Home Inventory Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #88B0A4;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: background 0.5s ease;
        }

        body.bg-expired {
            background: #DD6E67;
        }

        body.bg-warning {
            background: #E87461;
        }

        body.bg-caution {
            background: #C9AF98;
        }

        body.bg-good {
            background: #88B0A4;
        }

        body.bg-fresh {
            background: #194A52;
        }

        .dashboard-container {
            width: 100%;
            max-width: 800px;
            position: relative;
            min-height: 400px;
        }

        .settings-button {
            position: absolute;
            top: -60px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 24px;
            color: white;
            transition: all 0.3s;
        }

        .settings-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .inventory-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .debug-card {
            background: white !important;
            border: 5px solid #DD6E67 !important;
        }

        .item-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .item-name {
            font-size: 36px;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 10px;
        }

        .item-category {
            font-size: 18px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .item-size {
            font-size: 16px;
            color: #999;
            margin-top: 5px;
        }

        .expiry-section {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .expiry-section.expired {
            background: rgba(221, 110, 103, 0.3);
            border: 3px solid #DD6E67;
        }

        .expiry-section.warning {
            background: rgba(232, 116, 97, 0.3);
            border: 3px solid #E87461;
        }

        .expiry-section.caution {
            background: rgba(201, 175, 152, 0.3);
            border: 3px solid #C9AF98;
        }

        .expiry-section.good {
            background: rgba(136, 176, 164, 0.3);
            border: 3px solid #88B0A4;
        }

        .expiry-section.fresh {
            background: rgba(25, 74, 82, 0.3);
            border: 3px solid #194A52;
        }

        .expiry-label {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            opacity: 0.7;
        }

        .expiry-date {
            font-size: 24px;
            font-weight: bold;
        }

        .quantities-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .quantity-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .quantity-label {
            font-size: 16px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .quantity-display {
            font-size: 48px;
            font-weight: bold;
            color: #1a1a1a;
            margin: 15px 0;
        }

        .quantity-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .quantity-button {
            background: #C9AF98;
            color: white;
            border: none;
            border-radius: 10px;
            width: 60px;
            height: 60px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quantity-button:hover {
            background: #B89D85;
            transform: scale(1.05);
        }

        .quantity-button:active {
            transform: scale(0.95);
        }

        .last-update {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-top: 20px;
        }

        .update-confirmation {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #88B0A4;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            animation: slideIn 0.3s, slideOut 0.3s 2.7s;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .settings-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-header {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
            color: #333;
        }

        .settings-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .settings-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .weight-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .weight-item {
            display: flex;
            flex-direction: column;
        }

        .weight-label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #666;
        }

        .weight-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .settings-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .settings-button-action {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-button {
            background: #88B0A4;
            color: white;
        }

        .save-button:hover {
            background: #729688;
        }

        .cancel-button {
            background: #E5E7EB;
            color: #333;
        }

        .cancel-button:hover {
            background: #D1D5DB;
        }

        .loading-screen {
            text-align: center;
            color: white;
            font-size: 24px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #FEE2E2;
            color: #991B1B;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #C9AF98;
            transition: width 0.1s linear;
            border-radius: 0 0 0 20px;
        }

        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .login-screen {
            text-align: center;
        }

        .login-title {
            font-size: 32px;
            font-weight: bold;
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        .login-description {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .google-signin-button {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: #88B0A4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .google-signin-button:hover {
            background: #729688;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(136, 176, 164, 0.4);
        }

        .user-info {
            position: absolute;
            top: -60px;
            left: 0;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .signout-button {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            padding: 5px 12px;
            border-radius: 15px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .signout-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Default configuration
        const DEFAULT_CONFIG = {
            clientId: '',
            spreadsheetId: '',
            sheetName: 'Master',
            rotationInterval: 60,
            weights: {
                expired: 50,
                soon: 25,
                medium: 15,
                later: 7,
                fresh: 3
            }
        };

        // Google API settings
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // Load config from localStorage
        const loadConfig = () => {
            const saved = localStorage.getItem('inventoryDashboardSettings');
            if (saved) {
                return { ...DEFAULT_CONFIG, ...JSON.parse(saved) };
            }
            return DEFAULT_CONFIG;
        };

        // Save config to localStorage
        const saveConfig = (config) => {
            localStorage.setItem('inventoryDashboardSettings', JSON.stringify(config));
        };

        // Parse date from dd/mm/yyyy format
        const parseDate = (dateStr) => {
            if (!dateStr || dateStr.trim() === '') return null;
            const parts = dateStr.trim().split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            return new Date(year, month, day);
        };

        // Format date to dd/mm/yyyy
        const formatDate = (date) => {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        };

        // Calculate days until expiry
        const getDaysUntilExpiry = (expiryDate) => {
            if (!expiryDate) return Infinity;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate);
            expiry.setHours(0, 0, 0, 0);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        };

        // Get expiry status
        const getExpiryStatus = (daysUntilExpiry) => {
            if (daysUntilExpiry <= 7) return { status: 'expired', label: 'EXPIRED / EXPIRING SOON' };
            if (daysUntilExpiry <= 30) return { status: 'warning', label: 'EXPIRING WITHIN 1 MONTH' };
            if (daysUntilExpiry <= 90) return { status: 'caution', label: 'EXPIRING WITHIN 3 MONTHS' };
            if (daysUntilExpiry <= 180) return { status: 'good', label: 'EXPIRING WITHIN 6 MONTHS' };
            return { status: 'fresh', label: 'FRESH' };
        };

        // Get category for weighted rotation
        const getExpiryCategory = (daysUntilExpiry) => {
            if (daysUntilExpiry <= 7) return 'expired';
            if (daysUntilExpiry <= 30) return 'soon';
            if (daysUntilExpiry <= 90) return 'medium';
            if (daysUntilExpiry <= 180) return 'later';
            return 'fresh';
        };

        // Weighted random selection
        const weightedRandomSelect = (items, weights) => {
            const categorized = items.reduce((acc, item) => {
                const category = getExpiryCategory(getDaysUntilExpiry(item.expiryDate));
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});

            const pool = [];
            Object.keys(weights).forEach(category => {
                const categoryItems = categorized[category] || [];
                const weight = weights[category] || 0;
                for (let i = 0; i < weight; i++) {
                    pool.push(...categoryItems);
                }
            });

            if (pool.length === 0) return items[0];
            
            return pool[Math.floor(Math.random() * pool.length)];
        };

        // Main App Component
        function App() {
            const [config, setConfig] = useState(loadConfig());
            const [items, setItems] = useState([]);
            const [currentItem, setCurrentItem] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showConfirmation, setShowConfirmation] = useState(false);
            const [progress, setProgress] = useState(0);
            const [isSignedIn, setIsSignedIn] = useState(false);
            const [userEmail, setUserEmail] = useState('');
            const tokenClientRef = useRef(null);
            const accessTokenRef = useRef(null);

            // Initialize Google API
            useEffect(() => {
                const initializeGoogleAPI = () => {
                    if (!config.clientId) return;

                    tokenClientRef.current = google.accounts.oauth2.initTokenClient({
                        client_id: config.clientId,
                        scope: SCOPES,
                        ux_mode: 'popup',
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                accessTokenRef.current = tokenResponse.access_token;
                                setIsSignedIn(true);
                                fetchData();
                            } else if (tokenResponse.error) {
                                setError(`Authentication failed: ${tokenResponse.error}`);
                            }
                        },
                        error_callback: (error) => {
                            setError(`Authentication error: ${error.message || 'Unknown error'}`);
                        }
                    });
                };

                if (window.google && config.clientId) {
                    initializeGoogleAPI();
                }
            }, [config.clientId]);

            // Handle sign in
            const handleSignIn = () => {
                if (!config.clientId) {
                    setError('Please configure Client ID in settings');
                    setShowSettings(true);
                    return;
                }

                if (!config.spreadsheetId) {
                    setError('Please configure Spreadsheet ID in settings');
                    setShowSettings(true);
                    return;
                }

                if (tokenClientRef.current) {
                    try {
                        tokenClientRef.current.requestAccessToken({ prompt: 'consent' });
                    } catch (err) {
                        setError(`Sign in failed: ${err.message}`);
                    }
                }
            };

            // Handle sign out
            const handleSignOut = () => {
                accessTokenRef.current = null;
                setIsSignedIn(false);
                setItems([]);
                setCurrentItem(null);
                setUserEmail('');
                google.accounts.oauth2.revoke(accessTokenRef.current);
            };

            // Fetch data from Google Sheets
            const fetchData = useCallback(async () => {
                if (!accessTokenRef.current || !config.spreadsheetId) {
                    setLoading(false);
                    return;
                }

                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/${config.sheetName}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessTokenRef.current}`
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const rows = data.values;

                    if (!rows || rows.length === 0) {
                        throw new Error('No data found in spreadsheet');
                    }

                    const parsedItems = rows.slice(1).map((row, index) => ({
                        category: row[0] || '',
                        itemName: row[1] || '',
                        size: row[2] || '',
                        quantityStorage: parseInt(row[3]) || 0,
                        quantityKitchen: parseInt(row[4]) || 0,
                        expiryDate: parseDate(row[5]),
                        lastUpdate: row[6] || '',
                        rowIndex: index + 2
                    })).filter(item => item.itemName);

                    setItems(parsedItems);
                    
                    if (parsedItems.length > 0 && !currentItem) {
                        setCurrentItem(weightedRandomSelect(parsedItems, config.weights));
                    }
                    
                    setError(null);
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            }, [config.spreadsheetId, config.sheetName, config.weights, currentItem]);

            // Update quantity in Google Sheets
            const updateQuantity = async (location, delta) => {
                if (!currentItem || !accessTokenRef.current) return;

                const newItem = { ...currentItem };
                const today = formatDate(new Date());

                if (location === 'storage') {
                    newItem.quantityStorage = Math.max(0, newItem.quantityStorage + delta);
                } else {
                    newItem.quantityKitchen = Math.max(0, newItem.quantityKitchen + delta);
                }
                newItem.lastUpdate = today;

                setCurrentItem(newItem);
                setItems(items.map(item => 
                    item.rowIndex === newItem.rowIndex ? newItem : item
                ));

                try {
                    const range = `${config.sheetName}!D${newItem.rowIndex}:G${newItem.rowIndex}`;
                    const values = [[
                        newItem.quantityStorage.toString(),
                        newItem.quantityKitchen.toString(),
                        formatDate(newItem.expiryDate),
                        today
                    ]];

                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${config.spreadsheetId}/values/${range}?valueInputOption=RAW`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessTokenRef.current}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ values })
                        }
                    );

                    if (!response.ok) {
                        throw new Error('Failed to update sheet');
                    }

                    setShowConfirmation(true);
                    setTimeout(() => setShowConfirmation(false), 3000);
                } catch (err) {
                    console.error('Error updating sheet:', err);
                    setError('Failed to update. Please try again.');
                }
            };

            // Rotation effect
            useEffect(() => {
                if (items.length === 0 || !isSignedIn) return;

                const interval = setInterval(() => {
                    setCurrentItem(weightedRandomSelect(items, config.weights));
                    setProgress(0);
                }, config.rotationInterval * 1000);

                return () => clearInterval(interval);
            }, [items, config.rotationInterval, config.weights, isSignedIn]);

            // Progress bar effect
            useEffect(() => {
                if (!isSignedIn) return;

                const interval = setInterval(() => {
                    setProgress(prev => {
                        const increment = 100 / (config.rotationInterval * 10);
                        return prev + increment >= 100 ? 0 : prev + increment;
                    });
                }, 100);

                return () => clearInterval(interval);
            }, [config.rotationInterval, isSignedIn]);

            // Initial data fetch
            useEffect(() => {
                if (isSignedIn) {
                    fetchData();
                    
                    const refreshInterval = setInterval(fetchData, 5 * 60 * 1000);
                    return () => clearInterval(refreshInterval);
                }
            }, [fetchData, isSignedIn]);

            // Handle settings save
            const handleSaveSettings = (newConfig) => {
                setConfig(newConfig);
                saveConfig(newConfig);
                setShowSettings(false);
                if (isSignedIn) {
                    setLoading(true);
                    setError(null);
                    fetchData();
                }
            };

            // Always show something - debug view
            if (!isSignedIn || !currentItem) {
                return (
                    <div className="dashboard-container">
                        <button className="settings-button" onClick={() => setShowSettings(true)}>
                            ‚öôÔ∏è
                        </button>
                        <div className="inventory-card debug-card">
                            {!isSignedIn ? (
                                <div className="login-screen">
                                    <div className="login-title">Home Inventory Dashboard</div>
                                    <div className="login-description">
                                        Sign in with your Google account to access and manage your inventory.
                                        <br/>
                                        You'll need to grant access to your Google Sheets.
                                    </div>
                                    <button className="google-signin-button" onClick={handleSignIn}>
                                        <svg width="18" height="18" viewBox="0 0 18 18">
                                            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                                            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                                            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
                                            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                                        </svg>
                                        Sign in with Google
                                    </button>
                                    {error && (
                                        <div className="error-message" style={{marginTop: '20px'}}>
                                            {error}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div style={{padding: '20px', textAlign: 'center'}}>
                                    <h1 style={{marginBottom: '30px', color: '#DD6E67', fontSize: '32px'}}>üîç DEBUG MODE</h1>
                                    <div style={{
                                        textAlign: 'left', 
                                        fontSize: '18px', 
                                        lineHeight: '2',
                                        background: '#f5f5f5',
                                        padding: '30px',
                                        borderRadius: '10px',
                                        border: '2px solid #ddd'
                                    }}>
                                        <div style={{marginBottom: '20px'}}>
                                            <strong style={{fontSize: '20px', color: '#194A52'}}>üìä Status:</strong><br/>
                                            ‚Ä¢ Signed in: {isSignedIn ? '‚úÖ YES' : '‚ùå NO'}<br/>
                                            ‚Ä¢ Loading: {loading ? '‚è≥ YES' : '‚úÖ NO'}<br/>
                                            ‚Ä¢ Items loaded: <strong>{items.length}</strong><br/>
                                            ‚Ä¢ Current item exists: {currentItem ? '‚úÖ YES' : '‚ùå NO'}<br/>
                                            ‚Ä¢ Has error: {error ? 'üî¥ YES' : '‚úÖ NO'}<br/>
                                        </div>
                                        <div style={{marginBottom: '20px'}}>
                                            <strong style={{fontSize: '20px', color: '#194A52'}}>‚öôÔ∏è Config:</strong><br/>
                                            ‚Ä¢ Client ID: {config.clientId ? '‚úÖ Set (' + config.clientId.substring(0, 20) + '...)' : '‚ùå Not set'}<br/>
                                            ‚Ä¢ Spreadsheet ID: {config.spreadsheetId ? '‚úÖ Set' : '‚ùå Not set'}<br/>
                                            ‚Ä¢ Sheet Name: <strong>{config.sheetName}</strong><br/>
                                        </div>
                                        {error && (
                                            <div style={{marginBottom: '20px', padding: '15px', background: '#FEE2E2', borderRadius: '8px'}}>
                                                <strong style={{color: '#991B1B', fontSize: '20px'}}>‚ùå Error:</strong><br/>
                                                <span style={{color: '#991B1B'}}>{error}</span>
                                            </div>
                                        )}
                                    </div>
                                    <div style={{marginTop: '30px', display: 'flex', gap: '15px', justifyContent: 'center', flexWrap: 'wrap'}}>
                                        <button 
                                            onClick={() => {
                                                setLoading(true);
                                                setError(null);
                                                fetchData();
                                            }}
                                            style={{
                                                padding: '15px 30px',
                                                background: '#88B0A4',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '10px',
                                                cursor: 'pointer',
                                                fontSize: '18px',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            üîÑ Retry Loading Data
                                        </button>
                                        <button 
                                            onClick={handleSignOut}
                                            style={{
                                                padding: '15px 30px',
                                                background: '#DD6E67',
                                                color: 'white',
                                                border: 'none',
                                                borderRadius: '10px',
                                                cursor: 'pointer',
                                                fontSize: '18px',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            üö™ Sign Out
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                        {showSettings && (
                            <SettingsModal 
                                config={config}
                                onSave={handleSaveSettings}
                                onClose={() => setShowSettings(false)}
                            />
                        )}
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="dashboard-container">
                        <div className="inventory-card" style={{background: 'white'}}>
                            <div className="loading-screen" style={{color: '#333'}}>
                                <div className="loading-spinner"></div>
                                <div>Loading inventory...</div>
                                <div style={{marginTop: '20px', fontSize: '14px', opacity: 0.8}}>
                                    Signed in: {isSignedIn ? 'Yes' : 'No'}<br/>
                                    Items loaded: {items.length}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="dashboard-container">
                        <button className="settings-button" onClick={() => setShowSettings(true)}>
                            ‚öôÔ∏è
                        </button>
                        <div className="inventory-card">
                            <div className="error-message">
                                <h2>Error</h2>
                                <p style={{marginTop: '10px'}}>{error}</p>
                                <div style={{marginTop: '15px', fontSize: '12px', opacity: 0.8}}>
                                    Items loaded: {items.length}<br/>
                                    Signed in: {isSignedIn ? 'Yes' : 'No'}
                                </div>
                                <button 
                                    onClick={() => {
                                        setError(null);
                                        setLoading(true);
                                        fetchData();
                                    }}
                                    style={{
                                        marginTop: '15px',
                                        padding: '10px 20px',
                                        background: '#88B0A4',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '8px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Retry
                                </button>
                            </div>
                        </div>
                        {showSettings && (
                            <SettingsModal 
                                config={config}
                                onSave={handleSaveSettings}
                                onClose={() => setShowSettings(false)}
                            />
                        )}
                    </div>
                );
            }

            const daysUntilExpiry = getDaysUntilExpiry(currentItem.expiryDate);
            const expiryInfo = getExpiryStatus(daysUntilExpiry);

            // Update body background color based on expiry status
            useEffect(() => {
                if (currentItem) {
                    document.body.className = `bg-${expiryInfo.status}`;
                }
                return () => {
                    document.body.className = '';
                };
            }, [currentItem, expiryInfo.status]);

            return (
                <div className="dashboard-container">
                    {userEmail && (
                        <div className="user-info">
                            <span>{userEmail}</span>
                            <button className="signout-button" onClick={handleSignOut}>
                                Sign Out
                            </button>
                        </div>
                    )}
                    
                    <button className="settings-button" onClick={() => setShowSettings(true)}>
                        ‚öôÔ∏è
                    </button>

                    <div className="inventory-card">
                        <div className="item-header">
                            <div className="item-name">{currentItem.itemName}</div>
                            <div className="item-category">{currentItem.category}</div>
                            {currentItem.size && <div className="item-size">{currentItem.size}</div>}
                        </div>

                        <div className={`expiry-section ${expiryInfo.status}`}>
                            <div className="expiry-label">{expiryInfo.label}</div>
                            <div className="expiry-date">
                                {currentItem.expiryDate ? formatDate(currentItem.expiryDate) : 'No expiry date'}
                            </div>
                            {currentItem.expiryDate && (
                                <div style={{marginTop: '5px', fontSize: '14px'}}>
                                    ({daysUntilExpiry} days {daysUntilExpiry >= 0 ? 'remaining' : 'overdue'})
                                </div>
                            )}
                        </div>

                        <div className="quantities-section">
                            <div className="quantity-box">
                                <div className="quantity-label">Storage</div>
                                <div className="quantity-display">{currentItem.quantityStorage}</div>
                                <div className="quantity-buttons">
                                    <button 
                                        className="quantity-button"
                                        onClick={() => updateQuantity('storage', -1)}
                                    >
                                        -1
                                    </button>
                                    <button 
                                        className="quantity-button"
                                        onClick={() => updateQuantity('storage', 1)}
                                    >
                                        +1
                                    </button>
                                </div>
                            </div>

                            <div className="quantity-box">
                                <div className="quantity-label">Kitchen</div>
                                <div className="quantity-display">{currentItem.quantityKitchen}</div>
                                <div className="quantity-buttons">
                                    <button 
                                        className="quantity-button"
                                        onClick={() => updateQuantity('kitchen', -1)}
                                    >
                                        -1
                                    </button>
                                    <button 
                                        className="quantity-button"
                                        onClick={() => updateQuantity('kitchen', 1)}
                                    >
                                        +1
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="last-update">
                            Last updated: {currentItem.lastUpdate || 'Never'}
                        </div>

                        <div className="progress-bar" style={{width: `${progress}%`}}></div>
                    </div>

                    {showConfirmation && (
                        <div className="update-confirmation">
                            ‚úì Updated successfully!
                        </div>
                    )}

                    {showSettings && (
                        <SettingsModal 
                            config={config}
                            onSave={handleSaveSettings}
                            onClose={() => setShowSettings(false)}
                        />
                    )}
                </div>
            );
        }

        // Settings Modal Component
        function SettingsModal({ config, onSave, onClose }) {
            const [localConfig, setLocalConfig] = useState(config);

            const handleSave = () => {
                const totalWeight = Object.values(localConfig.weights).reduce((a, b) => a + b, 0);
                if (totalWeight !== 100) {
                    alert('Warning: Weights should add up to 100 for accurate distribution');
                }
                onSave(localConfig);
            };

            return (
                <div className="settings-modal" onClick={onClose}>
                    <div className="settings-content" onClick={e => e.stopPropagation()}>
                        <div className="settings-header">Dashboard Settings</div>

                        <div className="settings-section">
                            <label className="settings-label">Google OAuth Client ID</label>
                            <input
                                type="text"
                                className="settings-input"
                                value={localConfig.clientId}
                                onChange={e => setLocalConfig({...localConfig, clientId: e.target.value})}
                                placeholder="Enter your OAuth Client ID"
                            />
                            <div className="help-text">Get this from Google Cloud Console - OAuth 2.0 Client IDs</div>
                        </div>

                        <div className="settings-section">
                            <label className="settings-label">Spreadsheet ID</label>
                            <input
                                type="text"
                                className="settings-input"
                                value={localConfig.spreadsheetId}
                                onChange={e => setLocalConfig({...localConfig, spreadsheetId: e.target.value})}
                                placeholder="Found in your Google Sheets URL"
                            />
                            <div className="help-text">From the URL: docs.google.com/spreadsheets/d/[SPREADSHEET_ID]/edit</div>
                        </div>

                        <div className="settings-section">
                            <label className="settings-label">Sheet Name</label>
                            <input
                                type="text"
                                className="settings-input"
                                value={localConfig.sheetName}
                                onChange={e => setLocalConfig({...localConfig, sheetName: e.target.value})}
                                placeholder="e.g., Master"
                            />
                        </div>

                        <div className="settings-section">
                            <label className="settings-label">Rotation Interval (seconds)</label>
                            <input
                                type="number"
                                className="settings-input"
                                value={localConfig.rotationInterval}
                                onChange={e => setLocalConfig({...localConfig, rotationInterval: parseInt(e.target.value) || 60})}
                                min="5"
                                max="300"
                            />
                        </div>

                        <div className="settings-section">
                            <label className="settings-label">Display Frequency Weights (%)</label>
                            <div className="help-text" style={{marginBottom: '10px'}}>Should add up to 100</div>
                            <div className="weight-grid">
                                <div className="weight-item">
                                    <span className="weight-label">Expired (‚â§7 days)</span>
                                    <input
                                        type="number"
                                        className="weight-input"
                                        value={localConfig.weights.expired}
                                        onChange={e => setLocalConfig({
                                            ...localConfig, 
                                            weights: {...localConfig.weights, expired: parseInt(e.target.value) || 0}
                                        })}
                                        min="0"
                                        max="100"
                                    />
                                </div>
                                <div className="weight-item">
                                    <span className="weight-label">Soon (‚â§30 days)</span>
                                    <input
                                        type="number"
                                        className="weight-input"
                                        value={localConfig.weights.soon}
                                        onChange={e => setLocalConfig({
                                            ...localConfig, 
                                            weights: {...localConfig.weights, soon: parseInt(e.target.value) || 0}
                                        })}
                                        min="0"
                                        max="100"
                                    />
                                </div>
                                <div className="weight-item">
                                    <span className="weight-label">Medium (‚â§90 days)</span>
                                    <input
                                        type="number"
                                        className="weight-input"
                                        value={localConfig.weights.medium}
                                        onChange={e => setLocalConfig({
                                            ...localConfig, 
                                            weights: {...localConfig.weights, medium: parseInt(e.target.value) || 0}
                                        })}
                                        min="0"
                                        max="100"
                                    />
                                </div>
                                <div className="weight-item">
                                    <span className="weight-label">Later (‚â§180 days)</span>
                                    <input
                                        type="number"
                                        className="weight-input"
                                        value={localConfig.weights.later}
                                        onChange={e => setLocalConfig({
                                            ...localConfig, 
                                            weights: {...localConfig.weights, later: parseInt(e.target.value) || 0}
                                        })}
                                        min="0"
                                        max="100"
                                    />
                                </div>
                                <div className="weight-item">
                                    <span className="weight-label">Fresh (>180 days)</span>
                                    <input
                                        type="number"
                                        className="weight-input"
                                        value={localConfig.weights.fresh}
                                        onChange={e => setLocalConfig({
                                            ...localConfig, 
                                            weights: {...localConfig.weights, fresh: parseInt(e.target.value) || 0}
                                        })}
                                        min="0"
                                        max="100"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="settings-buttons">
                            <button className="settings-button-action cancel-button" onClick={onClose}>
                                Cancel
                            </button>
                            <button className="settings-button-action save-button" onClick={handleSave}>
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
